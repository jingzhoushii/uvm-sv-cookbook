# ============================================================
# File: ci.yml
# Description: UVM-SV Cookbook CI/CD 工作流
# Author: uvm-sv-cookbook
# ============================================================

name: UVM-SV Cookbook CI

on:
  push:
    branches: [main]
    paths:
      - '**.sv'
      - '**.md'
      - 'Makefile*'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # 作业: 代码检查
  check:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 检查文件结构
      - name: Check file structure
        run: |
          echo "检查目录结构..."
          
          # 统计 SV 文件
          sv_count=$(find . -name "*.sv" | wc -l)
          echo "SV 文件数量: $sv_count"
          
          # 检查章节结构
          chapter_count=$(find . -maxdepth 2 -name "README.md" | wc -l)
          echo "章节数量: $chapter_count"
          
          # 验证 Makefile 存在
          makefile_count=$(find . -name "Makefile" | wc -l)
          echo "Makefile 数量: $makefile_count"
          
          if [ "$sv_count" -lt 100 ]; then
            echo "警告: SV 文件少于 100 个"
          fi
          
          echo "✅ 文件结构检查完成"

  # 作业: 文档检查
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check documentation
        run: |
          echo "检查文档..."
          
          # 检查 README
          readme_count=$(find . -name "README*.md" | wc -l)
          echo "README 文件: $readme_count"
          
          # 检查学习材料
          if [ -d "docs" ]; then
            echo "✅ 存在 docs 目录"
            doc_count=$(find docs -name "*.md" | wc -l)
            echo "文档数量: $doc_count"
          else
            echo "❌ 缺少 docs 目录"
          fi
          
          # 检查练习答案
          if [ -d "docs/exercises/answers" ]; then
            echo "✅ 存在练习答案"
          else
            echo "⚠️ 缺少练习答案目录"
          fi
          
          echo "✅ 文档检查完成"

  # 作业: 代码统计
  stats:
    name: Statistics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate statistics
        id: stats
        run: |
          # 统计代码行数
          sv_lines=$(find . -name "*.sv" -exec cat {} \; 2>/dev/null | wc -l)
          echo "SV 代码行数: $sv_lines"
          
          # 统计文档行数
          md_lines=$(find . -name "*.md" -exec cat {} \; 2>/dev/null | wc -l)
          echo "Markdown 行数: $md_lines"
          
          # 创建统计摘要
          echo "## 代码统计" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SV 文件: $(find . -name '*.sv' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- 代码行数: $sv_lines" >> $GITHUB_STEP_SUMMARY
          echo "- 文档: $(find . -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- 练习: $(find docs/exercises -name "*.md" 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY

  # 作业: 链接检查
  links:
    name: Link Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check markdown links
        run: |
          echo "检查 Markdown 链接..."
          
          # 简单的链接格式检查
          broken_links=$(grep -r "http.*\.git" . --include="*.md" 2>/dev/null | head -10)
          if [ -n "$broken_links" ]; then
            echo "发现链接:"
            echo "$broken_links"
          else
            echo "✅ 链接检查完成"
          fi

  # 作业: 结果汇总
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [check, docs, stats, links]
    
    steps:
      - name: Summary
        run: |
          echo "## ✅ CI/CD 执行完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 检查项目" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 代码质量检查" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 文档检查" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 代码统计" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 链接检查" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 项目指标" >> $GITHUB_STEP_SUMMARY
          echo "- SV 文件: $(find . -name '*.sv' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- 代码行数: $(find . -name '*.sv' -exec cat {} \; 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- 文档: $(find . -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 后续步骤" >> $GITHUB_STEP_SUMMARY
          echo "- 继续添加示例代码" >> $GITHUB_STEP_SUMMARY
          echo "- 完善练习答案" >> $GITHUB_STEP_SUMMARY
          echo "- 更新学习材料" >> $GITHUB_STEP_SUMMARY
          
          cat $GITHUB_STEP_SUMMARY

